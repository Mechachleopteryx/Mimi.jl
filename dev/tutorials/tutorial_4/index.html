<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>4 SA Functionality · Mimi.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>Mimi.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../">Home</a></li><li><a class="toctext" href="../../installation/">Installation Guide</a></li><li><a class="toctext" href="../../userguide/">User Guide</a></li><li><span class="toctext">Tutorials</span><ul><li><a class="toctext" href="../tutorial_main/">Tutorials Intro</a></li><li><a class="toctext" href="../tutorial_1/">1 Run an Existing Model</a></li><li><a class="toctext" href="../tutorial_2/">2 Modify an Existing Model</a></li><li><a class="toctext" href="../tutorial_3/">3 Create a Model</a></li><li class="current"><a class="toctext" href>4 SA Functionality</a><ul class="internal"><li><a class="toctext" href="#The-API-1">The API</a></li><li><a class="toctext" href="#Two-Region-Model-Example-1">Two-Region Model Example</a></li><li><a class="toctext" href="#FUND-Example-1">FUND Example</a></li></ul></li></ul></li><li><a class="toctext" href="../../faq/">FAQ</a></li><li><a class="toctext" href="../../reference/">Reference</a></li><li><a class="toctext" href="../../integrationguide/">Integration Guide: Port to v0.5.0</a></li></ul></nav><article id="docs"><header><nav><ul><li>Tutorials</li><li><a href>4 SA Functionality</a></li></ul><a class="edit-page" href="https://github.com/mimiframework/Mimi.jl/blob/master/docs/src/tutorials/tutorial_4.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>4 SA Functionality</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Tutorial-4:-Sensitivity-Analysis-(SA)-Support-1" href="#Tutorial-4:-Sensitivity-Analysis-(SA)-Support-1">Tutorial 4: Sensitivity Analysis (SA) Support</a></h1><p>This tutorial walks through the SA functionality of Mimi, including core routines and examples.  We will start with looking at using the SA routines with the Mimi two-region model provided in the Mimi repository at <code>examples/tutorial/02-two-region-model</code>, and then build out to examine its use on <a href="http://www.fund-model.org">The Climate Framework for Uncertainty, Negotiation and Distribution (FUND)</a>, available on Github <a href="https://github.com/fund-model/fund">here</a>, </p><p>Working through the following tutorial will require:</p><ul><li><a href="https://julialang.org/downloads/">Julia v1.0.0</a> or higher</li><li><a href="https://github.com/mimiframework/Mimi.jl">Mimi v0.6.0</a> </li></ul><p>If you have not yet prepared these, go back to the main tutorial page and follow the instructions for their download.  </p><p>Futhermore, if you are not yet comfortable with downloading (only needs to be done once) and running FUND, refer to Tutorial 1 for instructions.  Carry out <strong>Steps 1 and 2</strong> from Tutorial 1, and then return to continue with this tutorial. Note that FUND is only requred for the second example in this tutorial. </p><h2><a class="nav-anchor" id="The-API-1" href="#The-API-1">The API</a></h2><p>The best current documentation on the SA API is the internals documentation <a href="https://github.com/anthofflab/Mimi.jl/blob/master/docs/src/internals/montecarlo.md">here</a>, which provides a working and informal description of the Sensitivity Analysis support of Mimi. This file should be used in conjunction with the examples below for details, since the documentation covers more advanced options such as non-stochastic scenarios and running multiple models, which are not yet included in this tutorial.</p><h2><a class="nav-anchor" id="Two-Region-Model-Example-1" href="#Two-Region-Model-Example-1">Two-Region Model Example</a></h2><p>This section will walk through the simple example provided in <code>&quot;Mimi.jl/test/sim/test_defsim.jl&quot;</code>.</p><h3><a class="nav-anchor" id="Step-1.-Setup-1" href="#Step-1.-Setup-1">Step 1. Setup</a></h3><p>First, set up for the tutorial as follows with the necessary packages and <code>main.jl</code> script for the two-region example.  You should have <code>Mimi</code> installed by now, and if you do not have <code>Distributions</code>, take a moment to add that package using by entering <code>]</code> to enter the <a href="https://docs.julialang.org/en/v1/stdlib/Pkg/index.html">Pkg REPL</a> mode and then typing <code>add Distributions</code>.</p><pre><code class="language-juila">cd(&lt;Mimi-directory-path&gt;) # Mimi-directory-path is a placeholder for the string describing the path of the Mimi directory
using Distributions

include(&quot;examples/tutorial/02-two-region-model/main.jl&quot;)
m = model # defined by 2-region model</code></pre><h3><a class="nav-anchor" id="Step-2.-Define-Random-Variables-1" href="#Step-2.-Define-Random-Variables-1">Step 2. Define Random Variables</a></h3><p>The <code>@defsim</code> macro, which defines random variables (RVs) which are assigned distributions and associated with model parameters, is the first step in the process. It also selects the sampling method, with simple random sampling being the default. Other options include Latin Hypercube Sampling, and Sobol Sampling.</p><pre><code class="language-julia">sim = @defsim begin
    # Define random variables. The rv() is required to disambiguate an
    # RV definition name = Dist(args...) from application of a distribution
    # to an external parameter. This makes the (less common) naming of an
    # RV slightly more burdensome, but it&#39;s only required when defining
    # correlations or sharing an RV across parameters.
    rv(name1) = Normal(1, 0.2)
    rv(name2) = Uniform(0.75, 1.25)
    rv(name3) = LogNormal(20, 4)

    # If using LHS, you can define correlations like this:
    sampling(LHSData, corrlist=[(:name1, :name2, 0.7), (:name1, :name3, 0.5)])

    # Exclude the sampling() call, or use the following for simple random sampling:
    # sampling(MCSData)

    # For Sobol sampling, specify N, and calc_second_order, which defaults to false.
    # sampling(SobolData, N=100000, calc_second_order=true)

    # assign RVs to model Parameters
    share = Uniform(0.2, 0.8)
    sigma[:, Region1] *= name2
    sigma[2020:5:2050, (Region2, Region3)] *= Uniform(0.8, 1.2)

    # Assign an array of distributions, keyed by region, to parameter depk
    depk = [Region1 =&gt; Uniform(0.7, 1.3),
            Region2 =&gt; Uniform(0.8, 1.2),
            Region3 =&gt; Normal()]

    # indicate which parameters to save for each model run. Specify
    # a parameter name or [later] some slice of its data, similar to the
    # assignment of RVs, above.
    save(grosseconomy.K, grosseconomy.YGROSS, 
         emissions.E, emissions.E_Global)
end</code></pre><h3><a class="nav-anchor" id="Step-2.-Optional-User-Defined-Functions-1" href="#Step-2.-Optional-User-Defined-Functions-1">Step 2. Optional User-Defined Functions</a></h3><p>Next, create the user-defined <code>print_result</code> function, which can be called as a post-trial function by <a href="../../reference/#Mimi.run_sim"><code>run_sim</code></a>.</p><pre><code class="language-julia"># Optional user functions can be called just before or after a trial is run
function print_result(m::Model, sim::Simulation, trialnum::Int)
    ci = Mimi.compinstance(m.mi, :emissions)
    value = Mimi.get_variable_value(ci, :E_Global)
    println(&quot;$(ci.comp_id).E_Global: $value&quot;)
end</code></pre><p>where <code>tup</code> is a tuple of scenario arguments representing one element in the cross-product of all scenario value vectors. In situations in which you want the SA loop to run only some of the models, the remainder of the runs can be handled using a <code>pre_trial_func</code> or <code>post_trial_func</code>.</p><h3><a class="nav-anchor" id="Step-2.-Generate-Trials-1" href="#Step-2.-Generate-Trials-1">Step 2. Generate Trials</a></h3><p>The  <a href="../../reference/#Mimi.generate_trials!"><code>generate_trials!</code></a> function generates all trial data, and save all random variable values in a file. Employ this function as follows:</p><pre><code class="language-julia"># Generate trial data for all RVs and (optionally) save to a file
generate_trials!(sim, 1000, filename=&quot;/tmp/trialdata.csv&quot;)</code></pre><h3><a class="nav-anchor" id="Step-4.-Run-Simulation-1" href="#Step-4.-Run-Simulation-1">Step 4. Run Simulation</a></h3><p>Finally, use the <a href="../../reference/#Mimi.set_models!"><code>set_models!</code></a> and <a href="../../reference/#Mimi.run_sim"><code>run_sim</code></a> functions.  First, calling [<code>set_models!</code>] with a model, marginal model, or list of models will set those models as those to be run by your <code>sim</code> simulation.  Next, use <a href="../../reference/#Mimi.run_sim"><code>run_sim</code></a> which runs a simulation, with parameters describing the number of trials and optional callback functions to customize simulation behavior. In its simplest use, the <a href="../../reference/#Mimi.run_sim"><code>run_sim</code></a> function iterates over all pre-generated trial data, perturbing a chosen set of Mimi&#39;s &quot;external parameters&quot;, based on the defined distributions, and then runs the given Mimi model. Optionally, trial values and/or model results are saved to CSV files.  View the internals documentation for <strong>critical and useful details on the full signature of this function</strong>:</p><pre><code class="language-none">function run_sim(sim::Simulation; 
                 trials::Union{Nothing, Int, Vector{Int}, AbstractRange{Int}} = nothing,
                 models_to_run::Int=length(sim.models),
                 ntimesteps::Int=typemax(Int), 
                 output_dir::Union{Nothing, AbstractString}=nothing, 
                 pre_trial_func::Union{Nothing, Function}=nothing, 
                 post_trial_func::Union{Nothing, Function}=nothing,
                 scenario_func::Union{Nothing, Function}=nothing,
                 scenario_placement::ScenarioLoopPlacement=OUTER,
                 scenario_args=nothing)</code></pre><p>Here, we first employ <a href="../../reference/#Mimi.run_sim"><code>run_sim</code></a> to obtain results:</p><pre><code class="language-julia"># Set models
set_models!(sim, m)

# Run trials 1:4, and save results to the indicated directory, one CSV file per RV
run_sim(sim, 4, output_dir=&quot;/tmp/Mimi&quot;)</code></pre><p>and then again using our user-defined post-trial function as the <code>post_trial_func</code> parameter:</p><pre><code class="language-julia"># Same thing but with a post-trial function
run_sim(m, sim, 4, post_trial_func=print_result, output_dir=&quot;/tmp/Mimi&quot;)</code></pre><h2><a class="nav-anchor" id="FUND-Example-1" href="#FUND-Example-1">FUND Example</a></h2><p>This example is in progress and will be built out soon.</p><footer><hr/><a class="previous" href="../tutorial_3/"><span class="direction">Previous</span><span class="title">3 Create a Model</span></a><a class="next" href="../../faq/"><span class="direction">Next</span><span class="title">FAQ</span></a></footer></article></body></html>
